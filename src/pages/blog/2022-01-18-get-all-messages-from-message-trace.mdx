---
templateKey: blog-post
title: Get all messages from message trace
date: 2022-01-18T11:13:18.089Z
description: Let's construct together a wrapper for Get-MessageTrace cmdlet.
featuredpost: false
tags:
  - exchange online
  - powershell
  - snippet
---
## The issue

## Constructing the loop

## Lowering memory usage

## Supporting more than 5M items

## Compiling script together
```powershell
$creds = (Get-Credential)
Connect-ExchangeOnline -Credential $creds

$Outfile = "C:\temp\ATPscan-$(Get-Date -Format "yyMMdd").csv"

# $MessageList = $null  
# $currentMessages = $null
$Page = 1

do {
  $currentMessages = $null
  if ($page % 25 -eq 0) { Connect-ExchangeOnline -Credential $creds }	
  Write-Host "Collecting Message Trace - Page $Page..."  
  $currentMessages = Get-MessageTrace -StartDate "2022-01-07" -EndDate "2022-01-17" -PageSize 5000 -Page $Page -Status Delivered #| Where {$_.Size -gt 1MB}
  $page++  
  $currentMessages | Export-Csv -Path $outFile -Append
  # $MessageList += $currentMessages  
  Start-Sleep -Seconds 1
}  
until ($CurrMessages -eq $null)
```
